{% extends "accounts/base.html" %}
{% block title %}Folder Fix - My Profile{% endblock %}

{% block content %}
<section class="py-5">
  <div class="container pt-4">

   

    <div class="row gy-4">
      <!-- Left: Profile Summary -->
      <div class="col-12 col-lg-4 d-flex">
        <div class="combo-card w-100 h-100 shadow-sm rounded">
          <div class="card-body text-center">
            <!-- Avatar placeholder -->
            <div class="mx-auto mb-3 rounded-circle d-flex align-items-center justify-content-center bg-light"
                 style="width:96px;height:96px;font-weight:600;font-size:28px;">
              {{ request.user.first_name|default:request.user.username|first|upper }}{{ request.user.last_name|first|upper }}
            </div>

            <h5 class="mb-1">{{ request.user.get_full_name|default:request.user.username }}</h5>
            <p class="text-muted mb-2"><i class="bi bi-person-circle me-1"></i>@{{ request.user.username }}</p>

            {% if profile.is_email_verified %}
              <span class="badge text-bg-success"><i class="bi bi-check-circle me-1"></i>Email Verified</span>
            {% else %}
              <span class="badge text-bg-warning"><i class="bi bi-exclamation-triangle me-1"></i>Email Not Verified</span>
            {% endif %}
          </div>

          <div class="list-group list-group-flush small">
            <div class="list-group-item d-flex justify-content-between">
              <span><i class="bi bi-envelope me-2"></i>Email</span>
              <span class="text-muted">{{ request.user.email|default:"—" }}</span>
            </div>
            <div class="list-group-item d-flex justify-content-between">
              <span><i class="bi bi-calendar-plus me-2"></i>Joined</span>
              <span class="text-muted">{{ request.user.date_joined|date:"M d, Y H:i" }}</span>
            </div>
            <div class="list-group-item d-flex justify-content-between">
              <span><i class="bi bi-clock-history me-2"></i>Last login</span>
              <span class="text-muted">{{ request.user.last_login|date:"M d, Y H:i" }}</span>
            </div>
          </div>

          <div class="card-body d-grid gap-2">
            <a class="btn btn-primary" href="{% url 'accounts:password-reset-request' %}">
              <i class="bi bi-key me-1"></i>Change Password
            </a>
            <a class="btn btn-danger" href="{% url 'accounts:logout' %}">
              <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
          </div>
        </div>
      </div>

      <!-- Right: Account Details + Membership -->
      <div class="col-12 col-lg-8 d-flex">
        <div class="common-card border-0 w-100 h-100 shadow-sm rounded">
          <div class="card-body">
            <h5 class="mb-3"><i class="bi bi-pencil-square me-2"></i>Account Details</h5>

            <form method="post" novalidate>
              {% csrf_token %}
              <div class="row gy-3">
                <div class="col-md-6">
                  <label class="form-label small text-uppercase text-muted">{{ form.first_name.label }}</label>
                  {{ form.first_name }}
                  {% if form.first_name.errors %}
                    <div class="invalid-feedback d-block">{{ form.first_name.errors|striptags }}</div>
                  {% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label small text-uppercase text-muted">{{ form.last_name.label }}</label>
                  {{ form.last_name }}
                  {% if form.last_name.errors %}
                    <div class="invalid-feedback d-block">{{ form.last_name.errors|striptags }}</div>
                  {% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label small text-uppercase text-muted">{{ form.username.label }}</label>
                  {{ form.username }}
                  {% if form.username.errors %}
                    <div class="invalid-feedback d-block">{{ form.username.errors|striptags }}</div>
                  {% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label small text-uppercase text-muted">Email</label>
                  <input class="form-control" value="{{ request.user.email }}" readonly>
                </div>
              </div>

              <div class="mt-4 d-flex gap-2">
                <button class="btn btn-primary"><i class="bi bi-save me-1"></i>Save Changes</button>
                <a href="{% url 'accounts:dashboard' %}" class="btn btn-danger px-4 pt-2">
                  <i class="bi bi-x-circle me-1"></i>Cancel
                </a>
              </div>
            </form>

            <hr class="my-4">

            <!-- Email verification -->
            <div class="row g-4 mt-2">
              <div class="col-lg-8 col-12">
                <h6 class="mb-1"><i class="bi bi-envelope-paper me-2"></i>Need to verify your email?</h6>
                <p class="text-muted small mb-0">If your email is not verified, use the button below to get OTP again.</p>
              </div>
              <div class="col-lg-4 col-12 d-grid">
                {% if not profile.is_email_verified %}
                  <form method="post" action="{% url 'accounts:resend-otp' request.user.id %}">
                    {% csrf_token %}
                    <button class="btn btn-primary"><i class="bi bi-send-check me-1"></i>Resend OTP</button>
                  </form>
                {% else %}
                  <button class="btn btn-success btn-sm" ><i class="bi bi-check-all me-1"></i>Already Verified</button>
                {% endif %}
              </div>
            </div>

            <hr class="my-4">

            <!-- Membership Info -->
            <h5 class="mb-3"><i class="bi bi-gem me-2 text-primary"></i>Membership</h5>
            {% if is_active %}
              <div class="btn btn-success btn-sm p-3 d-flex align-items-center">
                <i class="bi bi-check-circle-fill me-2"></i>
                Active — Valid till:
                {% if membership.expires_at %}
                  <strong class="ms-1">{{ membership.expires_at|date:"M d, Y H:i" }}</strong>
                {% else %}
                  <strong class="ms-1 text-dark">Not yet activated</strong>
                {% endif %}
              </div>
            {% else %}
              <div class="btn btn-warning my-3 btn-sm p-3 d-flex align-items-center">
                <i class="bi bi-x-circle-fill me-2"></i>Not Active
              </div>
              <form id="payForm" method="post" action="{% url 'member:create-order' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-credit-card me-2"></i>Pay ₹{{ price_rupees }} now
                </button>
              </form>
            {% endif %}

          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}
